<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Inventory - POS System</title>
    <meta name="description" content="Complete Point of Sale System with offline support">
    <meta name="theme-color" content="#7c3aed">
    <link rel="manifest" href="../manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="../assets/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="../assets/icons/icon-192x192.png">
    <script>
        // Prevent theme flicker - run before page renders
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.294.0/font/lucide.min.css">
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body>
    <div class="dashboard-layout">
        <div id="sidebarContainer"></div>
        
        <div class="main-content">
            <div id="topbarContainer"></div>
            
            <div class="content-wrapper">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">
                                <i data-lucide="package" class="label-icon"></i>
                                Total Items
                            </div>
                            <div class="stat-card-icon primary">
                                <i data-lucide="box"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="totalItems">0</div>
                        <div class="stat-card-change">
                            <i data-lucide="layers"></i>
                            <span>Products in stock</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">
                                <i data-lucide="trending-up" class="label-icon"></i>
                                Total Value
                            </div>
                            <div class="stat-card-icon success">
                                <i data-lucide="dollar-sign"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="totalValue">ZMW 0.00</div>
                        <div class="stat-card-change">
                            <i data-lucide="activity"></i>
                            <span>Inventory worth</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">
                                <i data-lucide="alert-triangle" class="label-icon"></i>
                                Low Stock
                            </div>
                            <div class="stat-card-icon warning">
                                <i data-lucide="alert-circle"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="lowStockItems">0</div>
                        <div class="stat-card-change">
                            <i data-lucide="package-x"></i>
                            <span>Need restocking</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">
                                <i data-lucide="trending-up" class="label-icon"></i>
                                Potential Profit
                            </div>
                            <div class="stat-card-icon info">
                                <i data-lucide="bar-chart"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="potentialProfit">ZMW 0.00</div>
                        <div class="stat-card-change">
                            <i data-lucide="arrow-up"></i>
                            <span>If all sold</span>
                        </div>
                    </div>
                </div>
                
                <!-- Inventory Table -->
                <div class="content-card">
                    <div class="content-card-header">
                        <h2 class="content-card-title">
                            <i data-lucide="package"></i>
                            Inventory Management
                        </h2>
                        <button class="action-btn" onclick="showAddItemModal()">
                            <i data-lucide="plus"></i>
                            Add Item
                        </button>
                    </div>
                    <div class="content-card-body">
                        <div class="search-filter-bar">
                            <div class="search-box">
                                <i data-lucide="search" class="search-icon"></i>
                                <input type="text" id="searchInventory" placeholder="Search products...">
                            </div>
                            <select id="filterStock" class="filter-select">
                                <option value="all">All Items</option>
                                <option value="low">Low Stock</option>
                                <option value="instock">In Stock</option>
                            </select>
                        </div>
                        
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th><i data-lucide="package" style="width: 14px; height: 14px; display: inline;"></i> Product Name</th>
                                        <th><i data-lucide="layers" style="width: 14px; height: 14px; display: inline;"></i> Quantity</th>
                                        <th><i data-lucide="arrow-down" style="width: 14px; height: 14px; display: inline;"></i> Buying Price/Item</th>
                                        <th><i data-lucide="arrow-up" style="width: 14px; height: 14px; display: inline;"></i> Selling Price/Item</th>
                                        <th><i data-lucide="trending-up" style="width: 14px; height: 14px; display: inline;"></i> Profit/Item</th>
                                        <th><i data-lucide="bar-chart" style="width: 14px; height: 14px; display: inline;"></i> Net Profit</th>
                                        <th><i data-lucide="settings" style="width: 14px; height: 14px; display: inline;"></i> Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryTableBody">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="emptyInventory" class="empty-state" style="display: none;">
                            <i data-lucide="package-x" class="empty-state-icon"></i>
                            <h3 class="empty-state-title">No Items in Inventory</h3>
                            <p class="empty-state-message">Start by adding your first product to the inventory</p>
                            <button class="action-btn" onclick="showAddItemModal()">
                                <i data-lucide="plus"></i>
                                Add First Item
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i data-lucide="package-plus" class="title-icon"></i>
                    <span id="modalTitle">Add Item</span>
                </h2>
                <button onclick="closeItemModal()" class="modal-close">
                    <i data-lucide="x"></i>
                </button>
            </div>
            
            <form id="itemForm" class="modal-form">
                <input type="hidden" id="itemId">
                
                <div class="form-group">
                    <label class="form-label">
                        <i data-lucide="tag" class="label-icon"></i>
                        Product Name
                    </label>
                    <input type="text" id="itemName" class="form-input" placeholder="Enter product name" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i data-lucide="layers" class="label-icon"></i>
                        Quantity
                    </label>
                    <input type="number" id="itemQuantity" class="form-input" placeholder="Enter quantity" min="0" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i data-lucide="arrow-down-circle" class="label-icon"></i>
                        Buying Price Per Item (ZMW)
                    </label>
                    <input type="number" id="itemBuyingPrice" class="form-input" placeholder="Enter buying price per item" step="0.01" min="0" required oninput="calculateProfits()">
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i data-lucide="arrow-up-circle" class="label-icon"></i>
                        Selling Price Per Item (ZMW)
                    </label>
                    <input type="number" id="itemSellingPrice" class="form-input" placeholder="Enter selling price per item" step="0.01" min="0" required oninput="calculateProfits()">
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i data-lucide="trending-up" class="label-icon"></i>
                        Profit Per Item (ZMW)
                    </label>
                    <input type="text" id="profitPerItem" class="form-input" readonly style="background: var(--bg-hover); font-weight: 700; color: var(--color-success);">
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i data-lucide="bar-chart" class="label-icon"></i>
                        Net Profit (ZMW)
                    </label>
                    <input type="text" id="netProfit" class="form-input" readonly style="background: var(--bg-hover); font-weight: 700; color: var(--color-success);">
                </div>
                
                <button type="submit" class="btn-primary">
                    <i data-lucide="check" class="btn-icon"></i>
                    <span id="submitBtnText">Add Item</span>
                </button>
            </form>
        </div>
    </div>

    <div id="toastContainer" class="toast-container"></div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="../assets/js/data.js"></script>
    <script src="../assets/js/sync.js"></script>
    <script src="../assets/js/script.js"></script>
    <script src="../assets/js/theme_toggle.js"></script>
    <script>
        if (!AppData.user || !isLoggedIn()) window.location.href = '../index.html';
        
        let editingItemId = null;
        
        function calculateProfits() {
            const quantity = parseFloat(document.getElementById('itemQuantity').value) || 0;
            const buyingPrice = parseFloat(document.getElementById('itemBuyingPrice').value) || 0;
            const sellingPrice = parseFloat(document.getElementById('itemSellingPrice').value) || 0;
            
            const profitPerItem = sellingPrice - buyingPrice;
            const netProfit = profitPerItem * quantity;
            
            document.getElementById('profitPerItem').value = formatCurrency(profitPerItem);
            document.getElementById('netProfit').value = formatCurrency(netProfit);
        }
        
        function loadInventoryData() {
            const stats = getDashboardStats();
            document.getElementById('totalItems').textContent = AppData.inventory.length;
            document.getElementById('totalValue').textContent = formatCurrency(stats.totalInventoryValue);
            document.getElementById('lowStockItems').textContent = stats.lowStockCount;
            document.getElementById('potentialProfit').textContent = formatCurrency(
                AppData.inventory.reduce((sum, item) => sum + item.netProfit, 0)
            );
            
            loadInventoryTable();
        }
        
        function loadInventoryTable() {
            const tbody = document.getElementById('inventoryTableBody');
            const emptyState = document.getElementById('emptyInventory');
            const searchTerm = document.getElementById('searchInventory').value.toLowerCase();
            const filterValue = document.getElementById('filterStock').value;
            
            let items = AppData.inventory.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm);
                const matchesFilter = filterValue === 'all' || 
                    (filterValue === 'low' && item.quantity <= AppData.settings.lowStockThreshold) ||
                    (filterValue === 'instock' && item.quantity > AppData.settings.lowStockThreshold);
                return matchesSearch && matchesFilter;
            });
            
            if (items.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'flex';
            } else {
                emptyState.style.display = 'none';
                tbody.innerHTML = items.map(item => `
                    <tr>
                        <td style="font-weight: 600;">${item.name}</td>
                        <td>
                            ${item.quantity <= AppData.settings.lowStockThreshold ? 
                                `<span class="badge warning">${item.quantity}</span>` : 
                                `<span class="badge success">${item.quantity}</span>`
                            }
                        </td>
                        <td>${formatCurrency(item.buyingPrice)}</td>
                        <td>${formatCurrency(item.sellingPrice)}</td>
                        <td style="color: var(--color-info); font-weight: 600;">${formatCurrency(item.profitPerItem || (item.sellingPrice - item.buyingPrice))}</td>
                        <td style="color: var(--color-success); font-weight: 600;">${formatCurrency(item.netProfit)}</td>
                        <td>
                            <div class="table-actions">
                                <button class="table-btn edit" onclick="editItem('${item.id}')" title="Edit">
                                    <i data-lucide="edit-2"></i>
                                </button>
                                <button class="table-btn delete" onclick="deleteItem('${item.id}')" title="Delete">
                                    <i data-lucide="trash-2"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            lucide.createIcons();
        }
        
        function showAddItemModal() {
            editingItemId = null;
            document.getElementById('modalTitle').textContent = 'Add Item';
            document.getElementById('submitBtnText').textContent = 'Add Item';
            document.getElementById('itemForm').reset();
            document.getElementById('itemModal').classList.add('active');
        }
        
        function closeItemModal() {
            document.getElementById('itemModal').classList.remove('active');
            document.getElementById('itemForm').reset();
            editingItemId = null;
        }
        
        function editItem(id) {
            const item = AppData.inventory.find(i => i.id === id);
            if (!item) return;
            
            editingItemId = id;
            document.getElementById('modalTitle').textContent = 'Edit Item';
            document.getElementById('submitBtnText').textContent = 'Update Item';
            document.getElementById('itemId').value = id;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemQuantity').value = item.quantity;
            document.getElementById('itemBuyingPrice').value = item.buyingPrice;
            document.getElementById('itemSellingPrice').value = item.sellingPrice;
            calculateProfits();
            document.getElementById('itemModal').classList.add('active');
        }
        
        function deleteItem(id) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            const result = deleteInventoryItem(id);
            if (result.success) {
                showToast(result.message, 'success');
                loadInventoryData();
            } else {
                showToast(result.message, 'error');
            }
        }
        
        document.getElementById('itemForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const itemData = {
                name: document.getElementById('itemName').value,
                quantity: document.getElementById('itemQuantity').value,
                buyingPrice: document.getElementById('itemBuyingPrice').value,
                sellingPrice: document.getElementById('itemSellingPrice').value
            };
            
            if (parseFloat(itemData.sellingPrice) < parseFloat(itemData.buyingPrice)) {
                showToast('Selling price cannot be less than buying price', 'warning');
                return;
            }
            
            let result;
            if (editingItemId) {
                result = updateInventoryItem(editingItemId, itemData);
            } else {
                result = addInventoryItem(itemData);
            }
            
            if (result.success) {
                showToast(result.message, 'success');
                closeItemModal();
                loadInventoryData();
            } else {
                showToast(result.message, 'error');
            }
        });
        
        document.getElementById('searchInventory').addEventListener('input', loadInventoryTable);
        document.getElementById('filterStock').addEventListener('change', loadInventoryTable);
        
        loadInventoryData();
        lucide.createIcons();
    </script>
</body>
</html>
