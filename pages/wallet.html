<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Wallet - POS System</title>
    <meta name="description" content="Complete Point of Sale System with offline support">
    <meta name="theme-color" content="#7c3aed">
    <link rel="manifest" href="../manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="../assets/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="../assets/icons/icon-192x192.png">
    <script>
        // Prevent theme flicker - run before page renders
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.294.0/font/lucide.min.css">
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body>
    <div class="dashboard-layout">
        <div id="sidebarContainer"></div>
        <div class="main-content">
            <div id="topbarContainer"></div>
            <div class="content-wrapper">
                <div class="wallet-card">
                    <div class="wallet-icon">
                        <i data-lucide="wallet"></i>
                    </div>
                    <div class="wallet-balance-label">Available Balance</div>
                    <div class="wallet-balance-amount" id="walletBalance">ZMW 0.00</div>
                    <div class="wallet-actions">
                        <button class="btn-primary" onclick="showTopUpModal()"><i data-lucide="arrow-down-circle"></i>Top Up</button>
                        <button class="btn-secondary" onclick="showWithdrawModal()"><i data-lucide="arrow-up-circle"></i>Withdraw</button>
                    </div>
                </div>
                <div class="content-card">
                    <div class="content-card-header">
                        <h2 class="content-card-title"><i data-lucide="history"></i>Transaction History</h2>
                    </div>
                    <div class="content-card-body">
                        <div id="transactionList" class="transaction-list"></div>
                        <div id="emptyTransactions" class="empty-state" style="display: none;">
                            <i data-lucide="wallet" class="empty-state-icon"></i>
                            <h3 class="empty-state-title">No Transactions</h3>
                            <p class="empty-state-message">Your wallet transactions will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="topUpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i data-lucide="arrow-down-circle" class="title-icon"></i>Top Up Wallet</h2>
                <button onclick="closeTopUpModal()" class="modal-close"><i data-lucide="x"></i></button>
            </div>
            <form id="topUpForm" class="modal-form">
                <div class="form-group">
                    <label class="form-label"><i data-lucide="dollar-sign" class="label-icon"></i>Amount (ZMW)</label>
                    <input type="number" id="topUpAmount" class="form-input" placeholder="Enter amount to add" step="0.01" min="0" required>
                </div>
                <button type="submit" class="btn-primary"><i data-lucide="check" class="btn-icon"></i>Top Up</button>
            </form>
        </div>
    </div>
    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i data-lucide="arrow-up-circle" class="title-icon"></i>Withdraw Funds</h2>
                <button onclick="closeWithdrawModal()" class="modal-close"><i data-lucide="x"></i></button>
            </div>
            <form id="withdrawForm" class="modal-form">
                <div class="form-group">
                    <label class="form-label"><i data-lucide="dollar-sign" class="label-icon"></i>Amount (ZMW)</label>
                    <input type="number" id="withdrawAmount" class="form-input" placeholder="Enter amount to withdraw" step="0.01" min="0" required>
                </div>
                <button type="submit" class="btn-primary"><i data-lucide="check" class="btn-icon"></i>Withdraw</button>
            </form>
        </div>
    </div>
    <div id="toastContainer" class="toast-container"></div>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="../assets/js/data.js"></script>
    <script src="../assets/js/sync.js"></script>
    <script src="../assets/js/script.js"></script>
    <script src="../assets/js/theme_toggle.js"></script>
    <script>
        if (!AppData.user || !isLoggedIn()) window.location.href = '../index.html';
        function loadWalletData() {
            document.getElementById('walletBalance').textContent = formatCurrency(AppData.wallet.balance);
            loadTransactions();
        }
        function loadTransactions() {
            const list = document.getElementById('transactionList');
            const empty = document.getElementById('emptyTransactions');
            const transactions = AppData.wallet.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            if (transactions.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'flex';
            } else {
                empty.style.display = 'none';
                list.innerHTML = transactions.map(t => {
                    const isIncome = t.amount > 0;
                    const icon = isIncome ? 'arrow-down-circle' : 'arrow-up-circle';
                    return `
                        <div class="transaction-item">
                            <div class="transaction-icon ${isIncome ? 'income' : 'expense'}">
                                <i data-lucide="${icon}"></i>
                            </div>
                            <div class="transaction-details">
                                <div class="transaction-type">${t.description}</div>
                                <div class="transaction-date">${new Date(t.date).toLocaleString()}</div>
                            </div>
                            <div class="transaction-amount ${isIncome ? 'positive' : 'negative'}">
                                ${isIncome ? '+' : ''}${formatCurrency(Math.abs(t.amount))}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            lucide.createIcons();
        }
        function showTopUpModal() { document.getElementById('topUpModal').classList.add('active'); }
        function closeTopUpModal() { document.getElementById('topUpModal').classList.remove('active'); document.getElementById('topUpForm').reset(); }
        function showWithdrawModal() { document.getElementById('withdrawModal').classList.add('active'); }
        function closeWithdrawModal() { document.getElementById('withdrawModal').classList.remove('active'); document.getElementById('withdrawForm').reset(); }
        document.getElementById('topUpForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const result = topUpWallet(document.getElementById('topUpAmount').value);
            if (result.success) {
                showToast(result.message, 'success');
                closeTopUpModal();
                loadWalletData();
            } else {
                showToast(result.message, 'error');
            }
        });
        document.getElementById('withdrawForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const result = withdrawFromWallet(document.getElementById('withdrawAmount').value);
            if (result.success) {
                showToast(result.message, 'success');
                closeWithdrawModal();
                loadWalletData();
            } else {
                showToast(result.message, 'error');
            }
        });
        loadWalletData();
        lucide.createIcons();
    </script>
</body>
</html>
