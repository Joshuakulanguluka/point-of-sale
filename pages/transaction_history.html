<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction History - POS System</title>
    <meta name="description" content="Complete Point of Sale System with offline support">
    <meta name="theme-color" content="#7c3aed">
    <link rel="manifest" href="../manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="../assets/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="../assets/icons/icon-192x192.png">
    <script>
        // Prevent theme flicker - run before page renders
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.294.0/font/lucide.min.css">
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body>
    <div class="dashboard-layout">
        <div id="sidebarContainer"></div>
        <div class="main-content">
            <div id="topbarContainer"></div>
            <div class="content-wrapper">
                <div class="content-card">
                    <div class="content-card-header">
                        <h2 class="content-card-title"><i data-lucide="history"></i>Transaction History</h2>
                    </div>
                    <div class="content-card-body">
                        <div class="search-filter-bar">
                            <div class="search-box">
                                <i data-lucide="search" class="search-icon"></i>
                                <input type="text" id="searchTransaction" placeholder="Search transactions...">
                            </div>
                            <select id="filterType" class="filter-select">
                                <option value="all">All Types</option>
                                <option value="sale">Sales</option>
                            </select>
                            <select id="filterDate" class="filter-select">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                        <div id="transactionList" class="transaction-list"></div>
                        <div id="emptyTransactions" class="empty-state" style="display: none;">
                            <i data-lucide="history" class="empty-state-icon"></i>
                            <h3 class="empty-state-title">No Transactions</h3>
                            <p class="empty-state-message">Your transaction history will appear here</p>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="paginationContainer" style="display: none; margin-top: var(--spacing-lg); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md);">
                            <div style="color: var(--text-secondary); font-size: var(--text-sm);">
                                Showing <span id="showingStart">0</span> to <span id="showingEnd">0</span> of <span id="totalItems">0</span> transactions
                            </div>
                            <div style="display: flex; gap: var(--spacing-xs); flex-wrap: wrap;">
                                <button id="prevPage" class="action-btn secondary" style="padding: 0.5rem 1rem;" onclick="changePage(-1)">
                                    <i data-lucide="chevron-left"></i>
                                    Previous
                                </button>
                                <div id="pageNumbers" style="display: flex; gap: var(--spacing-xs); flex-wrap: wrap;"></div>
                                <button id="nextPage" class="action-btn secondary" style="padding: 0.5rem 1rem;" onclick="changePage(1)">
                                    Next
                                    <i data-lucide="chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="toastContainer" class="toast-container"></div>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="../assets/js/data.js"></script>
    <script src="../assets/js/sync.js"></script>
    <script src="../assets/js/script.js"></script>
    <script src="../assets/js/theme_toggle.js"></script>
    <script>
        if (!AppData.user || !isLoggedIn()) window.location.href = '../index.html';
        
        let currentPage = 1;
        const itemsPerPage = 10;
        let allTransactions = [];
        
        function loadTransactions() {
            const searchTerm = document.getElementById('searchTransaction').value.toLowerCase();
            const filterType = document.getElementById('filterType').value;
            const filterDate = document.getElementById('filterDate').value;
            
            // Get date range based on filter
            const now = new Date();
            let startDate = null;
            
            switch(filterDate) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
            }
            
            // Filter and sort transactions (newest first)
            allTransactions = AppData.transactions.filter(t => {
                const matchesSearch = t.items.some(item => item.name.toLowerCase().includes(searchTerm));
                const matchesFilter = filterType === 'all' || t.type === filterType;
                const transactionDate = new Date(t.date);
                const matchesDate = !startDate || transactionDate >= startDate;
                return matchesSearch && matchesFilter && matchesDate;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            currentPage = 1; // Reset to first page on new search
            displayTransactions();
        }
        
        function displayTransactions() {
            const list = document.getElementById('transactionList');
            const empty = document.getElementById('emptyTransactions');
            const paginationContainer = document.getElementById('paginationContainer');
            
            if (allTransactions.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'flex';
                paginationContainer.style.display = 'none';
                return;
            }
            
            empty.style.display = 'none';
            
            // Calculate pagination
            const totalPages = Math.ceil(allTransactions.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, allTransactions.length);
            const paginatedTransactions = allTransactions.slice(startIndex, endIndex);
            
            // Display transactions
            list.innerHTML = paginatedTransactions.map(t => `
                <div class="transaction-item">
                    <div class="transaction-icon income">
                        <i data-lucide="shopping-cart"></i>
                    </div>
                    <div class="transaction-details">
                        <div class="transaction-type">Sale - ${t.items.map(item => `${item.name} (${item.quantity})`).join(', ')}</div>
                        <div class="transaction-date">${new Date(t.date).toLocaleString()}</div>
                    </div>
                    <div class="transaction-amount positive">+${formatCurrency(t.amount)}</div>
                    <button class="table-btn delete" onclick="deleteTransaction('${t.id}')" title="Delete">
                        <i data-lucide="trash-2"></i>
                    </button>
                </div>
            `).join('');
            
            // Update pagination info
            document.getElementById('showingStart').textContent = startIndex + 1;
            document.getElementById('showingEnd').textContent = endIndex;
            document.getElementById('totalItems').textContent = allTransactions.length;
            
            // Show/hide pagination
            if (allTransactions.length > itemsPerPage) {
                paginationContainer.style.display = 'flex';
                updatePaginationButtons(totalPages);
            } else {
                paginationContainer.style.display = 'none';
            }
            
            lucide.createIcons();
        }
        
        function updatePaginationButtons(totalPages) {
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            const pageNumbers = document.getElementById('pageNumbers');
            
            // Disable/enable prev/next buttons
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            prevBtn.style.opacity = currentPage === 1 ? '0.5' : '1';
            prevBtn.style.cursor = currentPage === 1 ? 'not-allowed' : 'pointer';
            nextBtn.style.opacity = currentPage === totalPages ? '0.5' : '1';
            nextBtn.style.cursor = currentPage === totalPages ? 'not-allowed' : 'pointer';
            
            // Generate page numbers
            pageNumbers.innerHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = 'action-btn secondary';
                pageBtn.style.padding = '0.5rem 1rem';
                pageBtn.style.minWidth = '40px';
                pageBtn.textContent = i;
                
                if (i === currentPage) {
                    pageBtn.style.background = 'var(--color-primary)';
                    pageBtn.style.color = '#0a0e1a';
                    pageBtn.style.fontWeight = '700';
                }
                
                pageBtn.onclick = () => goToPage(i);
                pageNumbers.appendChild(pageBtn);
            }
        }
        
        function changePage(direction) {
            const totalPages = Math.ceil(allTransactions.length / itemsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayTransactions();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        function goToPage(page) {
            currentPage = page;
            displayTransactions();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function deleteTransaction(id) {
            if (!confirm('Delete this transaction? Stock will be returned.')) return;
            const result = deleteSale(id);
            if (result.success) {
                showToast(result.message, 'success');
                loadTransactions();
            } else {
                showToast(result.message, 'error');
            }
        }
        
        document.getElementById('searchTransaction').addEventListener('input', loadTransactions);
        document.getElementById('filterType').addEventListener('change', loadTransactions);
        document.getElementById('filterDate').addEventListener('change', loadTransactions);
        loadTransactions();
        lucide.createIcons();
    </script>
</body>
</html>
