<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expenses - POS System</title>
    <meta name="description" content="Complete Point of Sale System with offline support">
    <meta name="theme-color" content="#7c3aed">
    <link rel="manifest" href="../manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="../assets/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="../assets/icons/icon-192x192.png">
    <script>
        // Prevent theme flicker - run before page renders
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.294.0/font/lucide.min.css">
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body>
    <div class="dashboard-layout">
        <div id="sidebarContainer"></div>
        <div class="main-content">
            <div id="topbarContainer"></div>
            <div class="content-wrapper">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title"><i data-lucide="receipt" class="label-icon"></i>Total Expenses</div>
                            <div class="stat-card-icon danger"><i data-lucide="trending-down"></i></div>
                        </div>
                        <div class="stat-card-value" id="totalExpenses">ZMW 0.00</div>
                        <div class="stat-card-change"><i data-lucide="calendar"></i><span>All time</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title"><i data-lucide="calendar" class="label-icon"></i>This Month</div>
                            <div class="stat-card-icon warning"><i data-lucide="calendar-days"></i></div>
                        </div>
                        <div class="stat-card-value" id="monthExpenses">ZMW 0.00</div>
                        <div class="stat-card-change"><i data-lucide="activity"></i><span id="monthName">Month</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title"><i data-lucide="calendar-check" class="label-icon"></i>Today</div>
                            <div class="stat-card-icon info"><i data-lucide="calendar-clock"></i></div>
                        </div>
                        <div class="stat-card-value" id="todayExpenses">ZMW 0.00</div>
                        <div class="stat-card-change"><i data-lucide="clock"></i><span>Today's spending</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title"><i data-lucide="list" class="label-icon"></i>Total Records</div>
                            <div class="stat-card-icon primary"><i data-lucide="file-text"></i></div>
                        </div>
                        <div class="stat-card-value" id="expenseCount">0</div>
                        <div class="stat-card-change"><i data-lucide="layers"></i><span>Expense entries</span></div>
                    </div>
                </div>
                <div class="content-card">
                    <div class="content-card-header">
                        <h2 class="content-card-title"><i data-lucide="receipt"></i>Expense History</h2>
                        <button class="action-btn" onclick="showAddExpenseModal()"><i data-lucide="plus"></i>Add Expense</button>
                    </div>
                    <div class="content-card-body">
                        <div class="search-filter-bar">
                            <div class="search-box">
                                <i data-lucide="search" class="search-icon"></i>
                                <input type="text" id="searchExpense" placeholder="Search expenses...">
                            </div>
                        </div>
                        <div id="expenseList" class="expense-list"></div>
                        <div id="emptyExpenses" class="empty-state" style="display: none;">
                            <i data-lucide="receipt" class="empty-state-icon"></i>
                            <h3 class="empty-state-title">No Expenses Recorded</h3>
                            <p class="empty-state-message">Start tracking your business expenses</p>
                            <button class="action-btn" onclick="showAddExpenseModal()"><i data-lucide="plus"></i>Add First Expense</button>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="paginationContainer" style="display: none; margin-top: var(--spacing-lg); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md);">
                            <div style="color: var(--text-secondary); font-size: var(--text-sm);">
                                Showing <span id="showingStart">0</span> to <span id="showingEnd">0</span> of <span id="totalItems">0</span> expenses
                            </div>
                            <div style="display: flex; gap: var(--spacing-xs); flex-wrap: wrap;">
                                <button id="prevPage" class="action-btn secondary" style="padding: 0.5rem 1rem;" onclick="changePage(-1)">
                                    <i data-lucide="chevron-left"></i>
                                    Previous
                                </button>
                                <div id="pageNumbers" style="display: flex; gap: var(--spacing-xs); flex-wrap: wrap;"></div>
                                <button id="nextPage" class="action-btn secondary" style="padding: 0.5rem 1rem;" onclick="changePage(1)">
                                    Next
                                    <i data-lucide="chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i data-lucide="receipt" class="title-icon"></i>Add Expense</h2>
                <button onclick="closeExpenseModal()" class="modal-close"><i data-lucide="x"></i></button>
            </div>
            <form id="expenseForm" class="modal-form">
                <div class="form-group">
                    <label class="form-label"><i data-lucide="tag" class="label-icon"></i>Expense Item</label>
                    <input type="text" id="expenseItem" class="form-input" placeholder="Enter expense description" required>
                </div>
                <div class="form-group">
                    <label class="form-label"><i data-lucide="dollar-sign" class="label-icon"></i>Amount (ZMW)</label>
                    <input type="number" id="expenseAmount" class="form-input" placeholder="Enter amount" step="0.01" min="0" required>
                </div>
                <button type="submit" class="btn-primary"><i data-lucide="check" class="btn-icon"></i>Add Expense</button>
            </form>
        </div>
    </div>
    <div id="toastContainer" class="toast-container"></div>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="../assets/js/data.js"></script>
    <script src="../assets/js/sync.js"></script>
    <script src="../assets/js/script.js"></script>
    <script src="../assets/js/theme_toggle.js"></script>
    <script>
        if (!AppData.user || !isLoggedIn()) window.location.href = '../index.html';
        
        let currentPage = 1;
        const itemsPerPage = 10;
        let allExpenses = [];
        
        function loadExpensesData() {
            const total = AppData.expenses.reduce((sum, e) => sum + e.amount, 0);
            const today = new Date().toDateString();
            const todayTotal = AppData.expenses.filter(e => new Date(e.date).toDateString() === today).reduce((sum, e) => sum + e.amount, 0);
            const month = new Date().getMonth();
            const monthTotal = AppData.expenses.filter(e => new Date(e.date).getMonth() === month).reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('totalExpenses').textContent = formatCurrency(total);
            document.getElementById('monthExpenses').textContent = formatCurrency(monthTotal);
            document.getElementById('todayExpenses').textContent = formatCurrency(todayTotal);
            document.getElementById('expenseCount').textContent = AppData.expenses.length;
            document.getElementById('monthName').textContent = new Date().toLocaleDateString('en-US', { month: 'long' });
            loadExpenseList();
        }
        
        function loadExpenseList() {
            const searchTerm = document.getElementById('searchExpense').value.toLowerCase();
            
            // Filter and sort expenses (newest first)
            allExpenses = AppData.expenses
                .filter(e => e.item.toLowerCase().includes(searchTerm))
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            currentPage = 1; // Reset to first page on new search
            displayExpenses();
        }
        
        function displayExpenses() {
            const list = document.getElementById('expenseList');
            const empty = document.getElementById('emptyExpenses');
            const paginationContainer = document.getElementById('paginationContainer');
            
            if (allExpenses.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'flex';
                paginationContainer.style.display = 'none';
                return;
            }
            
            empty.style.display = 'none';
            
            // Calculate pagination
            const totalPages = Math.ceil(allExpenses.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, allExpenses.length);
            const paginatedExpenses = allExpenses.slice(startIndex, endIndex);
            
            // Display expenses
            list.innerHTML = paginatedExpenses.map(e => `
                <div class="expense-item">
                    <div class="expense-info">
                        <div class="expense-name">${e.item}</div>
                        <div class="expense-date">${new Date(e.date).toLocaleString()}</div>
                    </div>
                    <div class="expense-amount">-${formatCurrency(e.amount)}</div>
                    <button class="table-btn delete" onclick="deleteExpenseItem('${e.id}')" title="Delete">
                        <i data-lucide="trash-2"></i>
                    </button>
                </div>
            `).join('');
            
            // Update pagination info
            document.getElementById('showingStart').textContent = startIndex + 1;
            document.getElementById('showingEnd').textContent = endIndex;
            document.getElementById('totalItems').textContent = allExpenses.length;
            
            // Show/hide pagination
            if (allExpenses.length > itemsPerPage) {
                paginationContainer.style.display = 'flex';
                updatePaginationButtons(totalPages);
            } else {
                paginationContainer.style.display = 'none';
            }
            
            lucide.createIcons();
        }
        
        function updatePaginationButtons(totalPages) {
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            const pageNumbers = document.getElementById('pageNumbers');
            
            // Disable/enable prev/next buttons
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            prevBtn.style.opacity = currentPage === 1 ? '0.5' : '1';
            prevBtn.style.cursor = currentPage === 1 ? 'not-allowed' : 'pointer';
            nextBtn.style.opacity = currentPage === totalPages ? '0.5' : '1';
            nextBtn.style.cursor = currentPage === totalPages ? 'not-allowed' : 'pointer';
            
            // Generate page numbers
            pageNumbers.innerHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = 'action-btn secondary';
                pageBtn.style.padding = '0.5rem 1rem';
                pageBtn.style.minWidth = '40px';
                pageBtn.textContent = i;
                
                if (i === currentPage) {
                    pageBtn.style.background = 'var(--color-primary)';
                    pageBtn.style.color = '#0a0e1a';
                    pageBtn.style.fontWeight = '700';
                }
                
                pageBtn.onclick = () => goToPage(i);
                pageNumbers.appendChild(pageBtn);
            }
        }
        
        function changePage(direction) {
            const totalPages = Math.ceil(allExpenses.length / itemsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayExpenses();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        function goToPage(page) {
            currentPage = page;
            displayExpenses();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        function showAddExpenseModal() {
            document.getElementById('expenseModal').classList.add('active');
        }
        function closeExpenseModal() {
            document.getElementById('expenseModal').classList.remove('active');
            document.getElementById('expenseForm').reset();
        }
        function deleteExpenseItem(id) {
            if (!confirm('Delete this expense? Amount will be refunded to wallet.')) return;
            const result = deleteExpense(id);
            if (result.success) {
                showToast(result.message, 'success');
                loadExpensesData();
            } else {
                showToast(result.message, 'error');
            }
        }
        document.getElementById('expenseForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const result = addExpense({
                item: document.getElementById('expenseItem').value,
                amount: document.getElementById('expenseAmount').value
            });
            if (result.success) {
                showToast(result.message, 'success');
                closeExpenseModal();
                loadExpensesData();
            } else {
                showToast(result.message, 'error');
            }
        });
        document.getElementById('searchExpense').addEventListener('input', loadExpenseList);
        loadExpensesData();
        lucide.createIcons();
    </script>
</body>
</html>
